应用场景
================================
1. 数据库备份文件清理 2013-05-24
    1. lgroup
    1. flines




数据库备份文件清理 2013-05-24
================================
现在有数据库备份系统：
- 使用mysqldump每小时将数据库全量备份一次
- 不同数据库备份文件以目录进行归类
- 所有备份文件存储在/extdata1/database-backup/目录下
- 文件保存规则是 /extdata1/database-backup/%s/%04d%02d%02d-%02d%02d%02d.sql % ( database_name, year, month, day, hour, minute, second )

现在要求清理3个月前的备份数据，每个数据库每天只保留1个备份文件。

### 解决方案

1. 因为备份文件在linux下，所以用以下步骤得到文件列表
    1. cd /extdata1/database-backup
    1. find . > /tmp/a.txt
1. 下载/tmp/a.txt到本地Windows机器上
1. 接下来就是使用我们的工具，筛选出哪些文件需要被删除
1. 主是使用lgroup工具进行归组后使用flines打印出需要被删除的文件名，方法如下

```
fprint a.txt | lsort | lgroup -m "\.\/(0-9a-zA-Z_\-)/2012(\d\d)(\d\d)-.*" -c "flines -n 2" > b.txt
```
lgroup的主要参数是-m，就是使用正则提取归组的元信息。比如这里提取出来的就是 数据名，月份，日期。这里将年份2012设定死，是根据实际情况来决定的，如果必须，也可以把年份作为元信息的一部分。

lgroup的-c选项，就是执行回调程序。回调程序从标准输入中接收分组信息，然后进行处理。

flines工具用于显示指定行内容。-n 2表示，显示从第2行开始的所有行。也就意味着，每个分组中，除第1个文件保留外，其它的文件将被删除。

这样，我们通过lgroup对文件进行归组，然后使用flines进行过滤，筛选出了需要删除的文件。得到删除文件列表后，就可以根据列表进行文件删除了。Linux下的一种实现方式就是

```
cat b.txt | xargs rm -f
```
当然，也可以将删除列表转化成删除语句组，然后批处理一下

```
cat b.txt | awk '{print "rm -f " $0}' > c.txt
. c.txt
```

(现在的工具集中，实现 awk '{print "rm -f " $0}' 的功能还没有，需要增加！#107)

